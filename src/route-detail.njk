---
layout: base.njk
pagination:
  data: allRoutes
  size: 1
  alias: route
permalink: "/routes/{{ route.id }}/"
eleventyComputed:
  title: "{{ route.name }} ‚Äî Skate And the City"
  metaDescription: "{{ route.name }} ‚Äî {{ route.description | truncate(140) }}"
---

<a href="{{ '/routes/' | url }}" class="text-skate-accent text-sm hover:underline mb-4 inline-block">&larr; All Routes</a>

<h1 class="text-3xl font-bold text-skate-accent mb-2">{{ route.name }}</h1>
<p class="text-gray-400 mb-6">{{ route.description }}</p>

<div class="flex flex-wrap gap-4 mb-8 text-sm text-gray-300">
  <span class="bg-skate-surface px-3 py-1.5 rounded-lg">‚è±Ô∏è {{ route.duration }}</span>
  <span class="bg-skate-surface px-3 py-1.5 rounded-lg">üìè {{ route.distance }}</span>
  <span class="bg-skate-surface px-3 py-1.5 rounded-lg">Difficulty: {% for i in range(1, 6) %}{% if i <= route.difficulty %}‚òÖ{% else %}‚òÜ{% endif %}{% endfor %}</span>
  <span class="bg-skate-surface px-3 py-1.5 rounded-lg">üìç {{ route.stops.length }} stops</span>
  <span class="bg-skate-surface px-3 py-1.5 rounded-lg">üèôÔ∏è {{ route.borough }}</span>
</div>

{# GPX Download & Open in Maps #}
<div class="flex flex-wrap gap-3 mb-8">
  <a href="{{ ('/assets/gpx/' + route.id + '.gpx') | url }}" download="{{ route.id }}.gpx"
     class="inline-flex items-center gap-2 bg-skate-accent text-black font-semibold px-4 py-2 rounded-lg hover:bg-yellow-400 transition text-sm">
    üì• Download GPX
  </a>
  <button id="generate-gpx-btn"
    class="inline-flex items-center gap-2 bg-skate-surface border border-skate-accent/30 text-skate-accent font-semibold px-4 py-2 rounded-lg hover:bg-skate-accent/10 transition text-sm">
    üîß Generate Custom GPX
  </button>
  <a id="google-maps-link" target="_blank" rel="noopener"
     class="inline-flex items-center gap-2 bg-skate-surface border border-skate-accent/30 text-gray-300 font-semibold px-4 py-2 rounded-lg hover:bg-skate-accent/10 transition text-sm">
    üó∫Ô∏è Open in Google Maps
  </a>
  <a id="apple-maps-link" target="_blank" rel="noopener"
     class="inline-flex items-center gap-2 bg-skate-surface border border-skate-accent/30 text-gray-300 font-semibold px-4 py-2 rounded-lg hover:bg-skate-accent/10 transition text-sm">
    üçé Open in Apple Maps
  </a>
</div>

{# Map #}
<div id="route-map" class="w-full h-80 rounded-lg border border-skate-accent/30 mb-8"></div>

{# Stop-by-stop breakdown #}
<h2 class="text-xl font-bold text-white mb-4">Stop-by-Stop</h2>
<div class="space-y-4">
  {% for stop in route.stops %}
  <details class="bg-skate-surface rounded-lg border border-skate-accent/20 group" {% if loop.first %}open{% endif %}>
    <summary class="flex items-center gap-3 p-4 cursor-pointer hover:bg-skate-accent/5 transition">
      <span class="flex-none w-8 h-8 rounded-full bg-skate-accent text-black font-bold flex items-center justify-center text-sm">{{ stop.order }}</span>
      <div class="flex-1 min-w-0">
        <span class="text-white font-semibold">{{ stop.spot.name }}</span>
        <span class="text-gray-500 text-sm ml-2">{{ stop.durationAtStop }}</span>
      </div>
    </summary>
    <div class="px-4 pb-4 pt-0 border-t border-skate-accent/10">
      <p class="text-gray-300 text-sm mt-3">{{ stop.activity }}</p>
      {% if stop.spot.neighborhood %}
      <p class="text-xs text-gray-500 mt-2">üìç {{ stop.spot.neighborhood }}, {{ stop.spot.borough }}</p>
      {% endif %}
      {% if stop.transitToNext %}
      <div class="mt-3 p-3 bg-skate-primary/60 rounded text-xs text-gray-400">
        <span class="text-skate-accent font-semibold">üõπ Getting to next stop:</span> {{ stop.transitToNext }}
      </div>
      {% endif %}
    </div>
  </details>
  {% endfor %}
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
(function() {
  const stops = {{ route.stops | dump | safe }};
  const coords = stops
    .filter(s => s.spot && s.spot.lat && s.spot.lng)
    .map(s => [s.spot.lat, s.spot.lng]);

  if (coords.length === 0) {
    document.getElementById('route-map').innerHTML = '<div class="flex items-center justify-center h-full text-gray-500">Map data coming soon ‚Äî coordinates being added</div>';
    return;
  }

  const map = L.map('route-map', { scrollWheelZoom: false }).fitBounds(coords, { padding: [30, 30] });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OSM &amp; CartoDB',
    maxZoom: 19
  }).addTo(map);

  // Route polyline
  L.polyline(coords, { color: '#f59e0b', weight: 3, opacity: 0.8, dashArray: '8 6' }).addTo(map);

  // Numbered markers
  stops.forEach(function(stop) {
    if (!stop.spot || !stop.spot.lat || !stop.spot.lng) return;
    const icon = L.divIcon({
      html: '<div style="background:#f59e0b;color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;border:2px solid #fff;">' + stop.order + '</div>',
      className: '',
      iconSize: [28, 28],
      iconAnchor: [14, 14]
    });
    L.marker([stop.spot.lat, stop.spot.lng], { icon: icon })
      .bindPopup('<strong>' + stop.spot.name + '</strong><br>' + stop.durationAtStop)
      .addTo(map);
  });
})();
</script>

<script>
(function() {
  const stops = {{ route.stops | dump | safe }};
  const routeName = {{ route.name | dump | safe }};
  const routeDesc = {{ route.description | dump | safe }};
  const routeId = {{ route.id | dump | safe }};

  function getCoords(stop) {
    const s = stop.spot;
    if (s && s.lat && s.lng) return { lat: s.lat, lng: s.lng };
    if (s && s.coordinates) return { lat: s.coordinates.lat, lng: s.coordinates.lng };
    return null;
  }

  function escXml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // Google Maps deep link (directions with waypoints)
  const coords = stops.map(s => getCoords(s)).filter(Boolean);
  if (coords.length >= 2) {
    const origin = coords[0].lat + ',' + coords[0].lng;
    const dest = coords[coords.length - 1].lat + ',' + coords[coords.length - 1].lng;
    const waypoints = coords.slice(1, -1).map(c => c.lat + ',' + c.lng).join('|');
    const gUrl = 'https://www.google.com/maps/dir/?api=1&origin=' + origin + '&destination=' + dest +
      (waypoints ? '&waypoints=' + waypoints : '') + '&travelmode=walking';
    document.getElementById('google-maps-link').href = gUrl;

    // Apple Maps
    const aCoords = coords.map(c => c.lat + ',' + c.lng);
    const aUrl = 'https://maps.apple.com/?dirflg=w&saddr=' + aCoords[0] + '&daddr=' + aCoords.slice(1).join('+to:');
    document.getElementById('apple-maps-link').href = aUrl;
  }

  // Client-side GPX generation
  document.getElementById('generate-gpx-btn').addEventListener('click', function() {
    let wpts = '';
    let trkpts = '';
    stops.forEach(function(stop) {
      const c = getCoords(stop);
      if (!c) return;
      const name = stop.spot ? stop.spot.name : stop.spotId;
      wpts += '  <wpt lat="'+c.lat+'" lon="'+c.lng+'">\n    <name>'+escXml(name)+'</name>\n    <desc>'+escXml(stop.activity||'')+'</desc>\n    <type>skate-stop</type>\n  </wpt>\n';
      trkpts += '      <trkpt lat="'+c.lat+'" lon="'+c.lng+'"><name>'+escXml(name)+'</name></trkpt>\n';
    });

    const gpx = '<?xml version="1.0" encoding="UTF-8"?>\n' +
      '<gpx version="1.1" creator="Skate And the City"\n' +
      '     xmlns="http://www.topografix.com/GPX/1/1"\n' +
      '     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\n' +
      '     xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd">\n' +
      '  <metadata>\n    <name>'+escXml(routeName)+'</name>\n    <desc>'+escXml(routeDesc)+'</desc>\n' +
      '    <author><name>Skate And the City</name></author>\n    <time>'+new Date().toISOString()+'</time>\n  </metadata>\n' +
      wpts +
      '  <trk>\n    <name>'+escXml(routeName)+'</name>\n    <trkseg>\n' + trkpts + '    </trkseg>\n  </trk>\n</gpx>';

    const blob = new Blob([gpx], { type: 'application/gpx+xml' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = routeId + '.gpx';
    a.click();
    URL.revokeObjectURL(a.href);
  });
})();
</script>

{# Gear Up ‚Äî Affiliate Recommendations #}
{% include "gear-up.njk" %}
